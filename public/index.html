<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Text Editor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            background: #263238;
            color: #eeffff;
            height: 100vh;
            overflow: hidden;
        }

        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .toolbar {
            background: #37474f;
            padding: 10px;
            display: flex;
            gap: 10px;
            align-items: center;
            border-bottom: 1px solid #455a64;
        }

        .toolbar button {
            background: #546e7a;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .toolbar button:hover {
            background: #607d8b;
        }

        .toolbar input {
            background: #546e7a;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
        }

        .toolbar select {
            background: #546e7a;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
        }

        .editor-container {
            flex: 1;
            display: flex;
        }

        .line-numbers {
            width: 60px;
            background: #37474f;
            border-right: 1px solid #455a64;
            padding: 10px 5px;
            font-size: 14px;
            color: #90a4ae;
            user-select: none;
            overflow: hidden;
            white-space: nowrap;
        }

        .editor {
            flex: 1;
            padding: 10px;
            font-size: 14px;
            line-height: 1.6;
            background: #263238;
            color: #eeffff;
            border: none;
            outline: none;
            resize: none;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            overflow-y: auto;
            tab-size: 4;
        }

        .status-bar {
            height: 24px;
            background: #37474f;
            color: #90a4ae;
            display: flex;
            align-items: center;
            padding: 0 10px;
            font-size: 12px;
            justify-content: space-between;
            border-top: 1px solid #455a64;
        }

        .line-number {
            display: block;
            height: 22.4px;
            line-height: 22.4px;
            text-align: right;
            padding-right: 10px;
        }

        .current-file {
            color: #81c784;
            font-weight: bold;
        }

        .unsaved {
            color: #ffb74d;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="toolbar">
            <button onclick="newFile()">New</button>
            <select id="fileSelect" onchange="loadSelectedFile()">
                <option value="">Select a file...</option>
            </select>
            <input type="text" id="filenameInput" placeholder="Enter filename..." style="width: 200px;">
            <button onclick="saveFile()">Save</button>
            <button onclick="deleteFile()">Delete</button>
        </div>
        
        <div class="editor-container">
            <div class="line-numbers" id="lineNumbers"></div>
            <textarea class="editor" id="editor" placeholder="Start typing..." spellcheck="false"></textarea>
        </div>
        
        <div class="status-bar">
            <span id="statusLeft">Ready</span>
            <span id="statusRight">Lines: 1 | Words: 0 | Characters: 0</span>
        </div>
    </div>

    <script>
        const editor = document.getElementById('editor');
        const lineNumbers = document.getElementById('lineNumbers');
        const statusLeft = document.getElementById('statusLeft');
        const statusRight = document.getElementById('statusRight');
        const fileSelect = document.getElementById('fileSelect');
        const filenameInput = document.getElementById('filenameInput');
        
        let currentFile = null;
        let hasUnsavedChanges = false;
        let autoSaveTimeout;

        // Initialize editor
        async function init() {
            await loadFileList();
            updateLineNumbers();
            updateStatus();
            setupEventListeners();
            editor.focus();
        }

        // Setup event listeners
        function setupEventListeners() {
            editor.addEventListener('input', handleInput);
            editor.addEventListener('scroll', syncScroll);
            editor.addEventListener('keydown', handleKeyDown);
            
            // Save on page unload
            window.addEventListener('beforeunload', (e) => {
                if (hasUnsavedChanges) {
                    e.preventDefault();
                    e.returnValue = '';
                }
            });
        }

        // Handle input changes
        function handleInput() {
            hasUnsavedChanges = true;
            updateLineNumbers();
            updateStatus();
            scheduleAutoSave();
        }

        // Handle keyboard shortcuts
        function handleKeyDown(e) {
            if (e.ctrlKey || e.metaKey) {
                switch(e.key) {
                    case 's':
                        e.preventDefault();
                        saveFile();
                        break;
                    case 'n':
                        e.preventDefault();
                        newFile();
                        break;
                    case 'o':
                        e.preventDefault();
                        // Focus file select
                        fileSelect.focus();
                        break;
                }
            }
            
            // Tab handling
            if (e.key === 'Tab') {
                e.preventDefault();
                const start = editor.selectionStart;
                const end = editor.selectionEnd;
                const value = editor.value;
                
                if (e.shiftKey) {
                    // Shift+Tab: Remove indentation
                    const lineStart = value.lastIndexOf('\n', start - 1) + 1;
                    const lineEnd = value.indexOf('\n', end);
                    const selectedLines = value.substring(lineStart, lineEnd === -1 ? value.length : lineEnd);
                    
                    if (selectedLines.startsWith('    ')) {
                        const newValue = value.substring(0, lineStart) + 
                                       selectedLines.replace(/^    /, '') + 
                                       value.substring(lineEnd === -1 ? value.length : lineEnd);
                        editor.value = newValue;
                        editor.setSelectionRange(start - 4, end - 4);
                    }
                } else {
                    // Tab: Add indentation
                    editor.value = value.substring(0, start) + '    ' + value.substring(end);
                    editor.setSelectionRange(start + 4, start + 4);
                }
                
                handleInput();
            }
        }

        // Load file list
        async function loadFileList() {
            try {
                const response = await fetch('/api/files');
                const files = await response.json();
                
                fileSelect.innerHTML = '<option value="">Select a file...</option>';
                files.forEach(file => {
                    const option = document.createElement('option');
                    option.value = file.name;
                    option.textContent = file.displayName;
                    fileSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading file list:', error);
                setStatus('Error loading files');
            }
        }

        // Load selected file
        async function loadSelectedFile() {
            const filename = fileSelect.value;
            if (!filename) return;
            
            if (hasUnsavedChanges) {
                if (!confirm('You have unsaved changes. Load file anyway?')) {
                    fileSelect.value = currentFile || '';
                    return;
                }
            }
            
            try {
                const response = await fetch(`/api/files/${filename}`);
                const data = await response.json();
                
                if (response.ok) {
                    editor.value = data.content;
                    currentFile = filename;
                    filenameInput.value = filename.replace('.txt', '');
                    hasUnsavedChanges = false;
                    updateLineNumbers();
                    updateStatus();
                    setStatus('File loaded');
                } else {
                    setStatus('Error loading file');
                }
            } catch (error) {
                console.error('Error loading file:', error);
                setStatus('Error loading file');
            }
        }

        // Save file
        async function saveFile() {
            const filename = filenameInput.value.trim();
            if (!filename) {
                alert('Please enter a filename');
                filenameInput.focus();
                return;
            }
            
            try {
                const response = await fetch(`/api/files/${filename}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ content: editor.value })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    currentFile = data.filename;
                    hasUnsavedChanges = false;
                    await loadFileList();
                    fileSelect.value = currentFile;
                    setStatus('File saved');
                } else {
                    setStatus(`Error: ${data.error}`);
                }
            } catch (error) {
                console.error('Error saving file:', error);
                setStatus('Error saving file');
            }
        }

        // Delete file
        async function deleteFile() {
            const filename = fileSelect.value;
            if (!filename) {
                alert('Please select a file to delete');
                return;
            }
            
            if (!confirm(`Are you sure you want to delete "${filename}"?`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/files/${filename}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    if (currentFile === filename) {
                        newFile();
                    }
                    await loadFileList();
                    setStatus('File deleted');
                } else {
                    setStatus(`Error: ${data.error}`);
                }
            } catch (error) {
                console.error('Error deleting file:', error);
                setStatus('Error deleting file');
            }
        }

        // New file
        function newFile() {
            if (hasUnsavedChanges) {
                if (!confirm('You have unsaved changes. Create new file anyway?')) {
                    return;
                }
            }
            
            editor.value = '';
            currentFile = null;
            filenameInput.value = '';
            fileSelect.value = '';
            hasUnsavedChanges = false;
            updateLineNumbers();
            updateStatus();
            setStatus('New file');
            editor.focus();
        }

        // Schedule auto-save
        function scheduleAutoSave() {
            if (autoSaveTimeout) {
                clearTimeout(autoSaveTimeout);
            }
            if (currentFile) {
                autoSaveTimeout = setTimeout(() => {
                    saveFile();
                }, 3000); // Auto-save after 3 seconds
            }
        }

        // Update line numbers
        function updateLineNumbers() {
            const lines = editor.value.split('\n');
            const lineCount = lines.length;
            
            lineNumbers.innerHTML = '';
            for (let i = 1; i <= lineCount; i++) {
                const lineNumber = document.createElement('div');
                lineNumber.className = 'line-number';
                lineNumber.textContent = i;
                lineNumbers.appendChild(lineNumber);
            }
        }

        // Sync scroll
        function syncScroll() {
            lineNumbers.scrollTop = editor.scrollTop;
        }

        // Update status
        function updateStatus() {
            const content = editor.value;
            const lines = content.split('\n').length;
            const words = content.trim() ? content.trim().split(/\s+/).length : 0;
            const chars = content.length;
            
            const fileStatus = currentFile ? 
                `${currentFile}${hasUnsavedChanges ? ' (unsaved)' : ''}` : 
                'Untitled';
            
            statusLeft.innerHTML = `<span class="${currentFile ? 'current-file' : ''} ${hasUnsavedChanges ? 'unsaved' : ''}">${fileStatus}</span>`;
            statusRight.textContent = `Lines: ${lines} | Words: ${words} | Characters: ${chars}`;
        }

        // Set temporary status
        function setStatus(message) {
            const originalLeft = statusLeft.innerHTML;
            statusLeft.textContent = message;
            setTimeout(() => {
                statusLeft.innerHTML = originalLeft;
            }, 3000);
        }

        // Initialize
        init();
    </script>
</body>
</html>